<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIDEKICK Kiosk Display</title>
    
    <!-- MQTT.js f√ºr WebSocket-Kommunikation -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Mauszeiger ausblenden */
        body.hide-cursor {
            cursor: none;
        }
        
        /* Scratch iframe Container */
        #scratch-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
        }
        
        #scratch-frame {
            border: none;
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        /* Status Overlay */
        #status-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 2rem 3rem;
            border-radius: 1rem;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid #555;
            transition: opacity 0.3s ease;
        }
        
        #status-overlay.connected {
            border-color: #4CAF50;
        }
        
        #status-overlay.disconnected {
            border-color: #ff9800;
        }
        
        #status-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .status-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .status-message {
            font-size: 1.25rem;
            color: #eee;
        }
        
        /* Connection Indicator */
        #connection-dot {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            z-index: 9999;
            transition: background-color 0.3s ease;
        }
        
        #connection-dot.connected {
            background-color: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }
        
        #connection-dot.disconnected {
            background-color: #ff9800;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Welcome Screen */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }
        
        #welcome-screen.hidden {
            display: none;
        }
        
        #welcome-screen h1 {
            font-size: 3rem;
            color: #0E9D59;
            margin-bottom: 1rem;
        }
        
        #welcome-screen p {
            font-size: 1.5rem;
            color: #aaa;
            margin-bottom: 2rem;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(14, 157, 89, 0.3);
            border-top-color: #0E9D59;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen (wird beim Laden eines Projekts ausgeblendet) -->
    <div id="welcome-screen">
        <h1>ü§ñ SIDEKICK Kiosk</h1>
        <p>Warte auf Projekt...</p>
        <div class="loading-spinner"></div>
        <p style="margin-top: 2rem; font-size: 1rem; color: #666;">
            √ñffne das Dashboard um ein Projekt zu starten
        </p>
    </div>
    
    <!-- Scratch Container -->
    <div id="scratch-container">
        <iframe id="scratch-frame" src="about:blank"></iframe>
    </div>
    
    <!-- Status Overlay -->
    <div id="status-overlay" class="disconnected">
        <div class="status-icon">‚è≥</div>
        <div class="status-message">Verbinde...</div>
    </div>
    
    <!-- Connection Indicator -->
    <div id="connection-dot" class="disconnected" title="MQTT Status"></div>
    
    <script>
        // ============================================
        // SIDEKICK Kiosk Controller
        // ============================================
        
        const CONFIG = {
            mqttBroker: window.location.hostname || '10.42.0.1',
            mqttPort: 9001,
            scratchPort: 8000,
            dashboardPort: 8080
        };
        
        // DOM Elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const scratchFrame = document.getElementById('scratch-frame');
        const statusOverlay = document.getElementById('status-overlay');
        const statusIcon = statusOverlay.querySelector('.status-icon');
        const statusMessage = statusOverlay.querySelector('.status-message');
        const connectionDot = document.getElementById('connection-dot');
        
        // State
        let mqttClient = null;
        let currentProject = null;
        let isConnected = false;
        let statusTimeout = null;
        
        // ============================================
        // Status Display Functions
        // ============================================
        
        function showStatus(icon, message, autoHide = true) {
            statusIcon.textContent = icon;
            statusMessage.textContent = message;
            statusOverlay.classList.remove('hidden');
            
            if (statusTimeout) {
                clearTimeout(statusTimeout);
            }
            
            if (autoHide) {
                statusTimeout = setTimeout(() => {
                    statusOverlay.classList.add('hidden');
                }, 3000);
            }
        }
        
        function hideStatus() {
            statusOverlay.classList.add('hidden');
        }
        
        function updateConnectionStatus(connected) {
            isConnected = connected;
            connectionDot.className = connected ? 'connected' : 'disconnected';
            statusOverlay.className = connected ? 'connected' : 'disconnected';
        }
        
        // ============================================
        // MQTT Functions
        // ============================================
        
        function connectMQTT() {
            const brokerUrl = `ws://${CONFIG.mqttBroker}:${CONFIG.mqttPort}`;
            console.log(`Verbinde zu MQTT: ${brokerUrl}`);
            
            showStatus('‚è≥', 'Verbinde zu MQTT...', false);
            
            mqttClient = mqtt.connect(brokerUrl, {
                clientId: 'sidekick-kiosk-' + Math.random().toString(16).substr(2, 8),
                clean: true,
                reconnectPeriod: 5000
            });
            
            mqttClient.on('connect', () => {
                console.log('MQTT verbunden!');
                updateConnectionStatus(true);
                showStatus('‚úì', 'Verbunden - Warte auf Projekt...');
                
                // Topics abonnieren
                mqttClient.subscribe('sidekick/display/#');
                
                // Status melden
                publishStatus();
            });
            
            mqttClient.on('error', (err) => {
                console.error('MQTT Fehler:', err);
                updateConnectionStatus(false);
                showStatus('‚ùå', `Verbindungsfehler: ${err.message}`, false);
            });
            
            mqttClient.on('close', () => {
                console.log('MQTT Verbindung geschlossen');
                updateConnectionStatus(false);
                showStatus('‚ö†Ô∏è', 'Verbindung verloren - Reconnecting...', false);
            });
            
            mqttClient.on('message', (topic, message) => {
                const payload = message.toString();
                console.log(`MQTT: ${topic} = ${payload}`);
                
                switch(topic) {
                    case 'sidekick/display/load':
                        loadProject(payload);
                        break;
                    case 'sidekick/display/start':
                        startProject();
                        break;
                    case 'sidekick/display/stop':
                        stopProject();
                        break;
                    case 'sidekick/display/status':
                        publishStatus();
                        break;
                }
            });
        }
        
        function publishStatus() {
            if (mqttClient && mqttClient.connected) {
                const status = {
                    status: currentProject ? 'loaded' : 'idle',
                    project: currentProject,
                    timestamp: new Date().toISOString()
                };
                mqttClient.publish('sidekick/display/state', JSON.stringify(status));
            }
        }
        
        // ============================================
        // Project Functions
        // ============================================
        
        function loadProject(projectName) {
            console.log(`Lade Projekt: ${projectName}`);
            currentProject = projectName;
            
            showStatus('‚è≥', `Lade ${projectName}...`, false);
            
            // Scratch Player mit Projekt laden
            // Wir nutzen den player.html und √ºbergeben das Projekt via postMessage
            const scratchUrl = `http://${CONFIG.mqttBroker}:${CONFIG.scratchPort}/player.html`;
            scratchFrame.src = scratchUrl;
            
            // Warte bis iframe geladen ist, dann Projekt laden
            scratchFrame.onload = async () => {
                try {
                    // Projekt vom Server laden
                    const projectUrl = `http://${CONFIG.mqttBroker}:${CONFIG.dashboardPort}/projects/${encodeURIComponent(projectName)}`;
                    const response = await fetch(projectUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    // Welcome Screen ausblenden
                    welcomeScreen.classList.add('hidden');
                    
                    showStatus('‚úì', `${projectName} geladen!`);
                    publishStatus();
                    
                    // Hinweis: Das eigentliche Laden ins Scratch geschieht via File-API
                    // Der User muss aktuell noch manuell laden - aber wir zeigen zumindest den Player
                    
                } catch (error) {
                    console.error('Fehler beim Laden:', error);
                    showStatus('‚ùå', `Fehler: ${error.message}`);
                }
            };
        }
        
        function startProject() {
            console.log('Starte Projekt (Gr√ºne Flagge)...');
            showStatus('‚ñ∂Ô∏è', 'Projekt gestartet!');
            
            // Sende Klick-Event an iframe
            // Hinweis: Aus Sicherheitsgr√ºnden k√∂nnen wir nicht direkt in den iframe greifen
            // Alternative: Custom Event System √ºber postMessage
            try {
                scratchFrame.contentWindow.postMessage({ type: 'greenFlag' }, '*');
            } catch (e) {
                console.log('Konnte greenFlag nicht senden:', e);
            }
            
            publishStatus();
        }
        
        function stopProject() {
            console.log('Stoppe Projekt...');
            showStatus('‚èπÔ∏è', 'Projekt gestoppt');
            
            try {
                scratchFrame.contentWindow.postMessage({ type: 'stopAll' }, '*');
            } catch (e) {
                console.log('Konnte stopAll nicht senden:', e);
            }
            
            publishStatus();
        }
        
        // ============================================
        // Cursor Auto-Hide
        // ============================================
        
        let cursorTimeout;
        
        function hideCursor() {
            document.body.classList.add('hide-cursor');
        }
        
        function showCursor() {
            document.body.classList.remove('hide-cursor');
            clearTimeout(cursorTimeout);
            cursorTimeout = setTimeout(hideCursor, 3000);
        }
        
        document.addEventListener('mousemove', showCursor);
        document.addEventListener('mousedown', showCursor);
        
        // ============================================
        // Initialize
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('SIDEKICK Kiosk gestartet');
            
            // Cursor nach 3 Sekunden ausblenden
            cursorTimeout = setTimeout(hideCursor, 3000);
            
            // MQTT verbinden
            connectMQTT();
        });
    </script>
</body>
</html>
