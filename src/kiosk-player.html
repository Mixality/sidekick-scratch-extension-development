<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIDEKICK Kiosk Player</title>
    
    <!-- MQTT.js f√ºr WebSocket-Kommunikation -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body.hide-cursor {
            cursor: none;
        }
        
        /* Scratch Stage Container */
        #scratch-stage {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
        }
        
        #scratch-stage canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Status Overlay */
        #status-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 2rem 3rem;
            border-radius: 1rem;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid #4CAF50;
            transition: opacity 0.3s ease;
        }
        
        #status-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #status-overlay.error {
            border-color: #f44336;
        }
        
        .status-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .status-message {
            font-size: 1.25rem;
            color: #eee;
        }
        
        /* Connection Indicator */
        #connection-dot {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            z-index: 9999;
            background-color: #ff9800;
        }
        
        #connection-dot.connected {
            background-color: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }
        
        /* Controls Overlay */
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 9998;
            display: flex;
            gap: 10px;
        }
        
        #controls button {
            padding: 10px 20px;
            font-size: 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        #controls button:active {
            transform: scale(0.95);
        }
        
        #btn-start {
            background: #4CAF50;
            color: white;
        }
        
        #btn-stop {
            background: #f44336;
            color: white;
        }
        
        /* Welcome Screen */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }
        
        #welcome-screen.hidden {
            display: none;
        }
        
        #welcome-screen h1 {
            font-size: 3rem;
            color: #0E9D59;
            margin-bottom: 1rem;
        }
        
        #welcome-screen p {
            font-size: 1.5rem;
            color: #aaa;
            margin-bottom: 2rem;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(14, 157, 89, 0.3);
            border-top-color: #0E9D59;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <h1>ü§ñ SIDEKICK Kiosk</h1>
        <p>Warte auf Projekt...</p>
        <div class="loading-spinner"></div>
        <p style="margin-top: 2rem; font-size: 1rem; color: #666;">
            √ñffne das Dashboard um ein Projekt zu starten
        </p>
    </div>
    
    <!-- Scratch Stage -->
    <div id="scratch-stage"></div>
    
    <!-- Controls (optional, f√ºr lokales Testen) -->
    <div id="controls" style="display: none;">
        <button id="btn-start">‚ñ∂Ô∏è Start</button>
        <button id="btn-stop">‚èπÔ∏è Stop</button>
    </div>
    
    <!-- Status Overlay -->
    <div id="status-overlay" class="hidden">
        <div class="status-icon">‚è≥</div>
        <div class="status-message">L√§dt...</div>
    </div>
    
    <!-- Connection Indicator -->
    <div id="connection-dot" title="MQTT Status"></div>
    
    <!-- Scratch VM und Renderer werden dynamisch geladen -->
    <script>
        // ============================================
        // SIDEKICK Kiosk Player
        // Standalone Player mit direkter VM-Kontrolle
        // ============================================
        
        const CONFIG = {
            mqttBroker: window.location.hostname || '10.42.0.1',
            mqttPort: 9001,
            scratchPort: 8000
        };
        
        // Globals
        let vm = null;
        let renderer = null;
        let audioEngine = null;
        let mqttClient = null;
        let currentProject = null;
        
        // DOM Elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const stageContainer = document.getElementById('scratch-stage');
        const statusOverlay = document.getElementById('status-overlay');
        const statusIcon = statusOverlay.querySelector('.status-icon');
        const statusMessage = statusOverlay.querySelector('.status-message');
        const connectionDot = document.getElementById('connection-dot');
        
        // ============================================
        // Status Functions
        // ============================================
        
        function showStatus(icon, message, autoHide = true, isError = false) {
            statusIcon.textContent = icon;
            statusMessage.textContent = message;
            statusOverlay.classList.remove('hidden');
            statusOverlay.classList.toggle('error', isError);
            
            if (autoHide) {
                setTimeout(() => statusOverlay.classList.add('hidden'), 3000);
            }
        }
        
        // ============================================
        // Scratch VM Setup
        // ============================================
        
        async function initializeScratchVM() {
            showStatus('‚è≥', 'Lade Scratch Engine...', false);
            
            try {
                // Dynamisch scratch-vm laden
                // Da wir die geb√ºndelte Version nicht direkt laden k√∂nnen,
                // nutzen wir einen iframe-basierten Ansatz mit dem Editor
                
                // F√ºr jetzt: Fallback auf iframe-Methode
                console.log('VM Initialisierung - nutze iframe Fallback');
                return false;
                
            } catch (error) {
                console.error('VM Init Fehler:', error);
                showStatus('‚ùå', 'Fehler beim Laden der Scratch Engine', false, true);
                return false;
            }
        }
        
        // ============================================
        // Project Loading (iframe-basiert)
        // ============================================
        
        function loadProjectInIframe(projectName) {
            console.log(`Lade Projekt: ${projectName}`);
            currentProject = projectName;
            showStatus('‚è≥', `Lade ${projectName}...`, false);
            
            // Wir nutzen den vollen Editor (index.html) und laden das Projekt via File API
            // Da der Editor sb-file-uploader hat, k√∂nnen wir das Projekt programmatisch laden
            
            const iframe = document.createElement('iframe');
            iframe.id = 'scratch-frame';
            iframe.style.cssText = 'border: none; width: 100%; height: 100%;';
            
            // Editor laden
            iframe.src = `http://${CONFIG.mqttBroker}:${CONFIG.scratchPort}/`;
            
            // Alte iframes entfernen
            const existingFrame = document.getElementById('scratch-frame');
            if (existingFrame) existingFrame.remove();
            
            stageContainer.appendChild(iframe);
            
            iframe.onload = async () => {
                console.log('Editor iframe geladen');
                welcomeScreen.classList.add('hidden');
                
                // Warte kurz bis der Editor vollst√§ndig initialisiert ist
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Versuche das Projekt zu laden
                try {
                    // Projekt-Datei fetchen
                    const projectUrl = `http://${CONFIG.mqttBroker}:${CONFIG.scratchPort}/projects/${encodeURIComponent(projectName)}`;
                    const response = await fetch(projectUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Projekt nicht gefunden: ${response.status}`);
                    }
                    
                    const projectData = await response.arrayBuffer();
                    console.log(`Projekt geladen: ${projectData.byteLength} bytes`);
                    
                    // Versuche VM im iframe zu finden und Projekt zu laden
                    const iframeWindow = iframe.contentWindow;
                    
                    // Warte auf VM
                    let attempts = 0;
                    const maxAttempts = 50;
                    
                    const checkVM = setInterval(() => {
                        attempts++;
                        
                        // Suche nach der VM im Redux Store oder global
                        try {
                            // Methode 1: √úber Redux Store
                            const reduxStore = iframeWindow.__REDUX_DEVTOOLS_EXTENSION__ && 
                                               iframeWindow.__REDUX_DEVTOOLS_EXTENSION__.store;
                            
                            // Methode 2: √úber globale Variable (wenn wir player.jsx gepatcht h√§tten)
                            if (iframeWindow.vm) {
                                clearInterval(checkVM);
                                console.log('VM gefunden (global)!');
                                iframeWindow.vm.loadProject(projectData).then(() => {
                                    showStatus('‚úì', `${projectName} bereit!`);
                                    publishStatus();
                                });
                                return;
                            }
                            
                            // Methode 3: √úber React DevTools
                            // ... kompliziert
                            
                        } catch (e) {
                            // Cross-origin oder nicht gefunden
                        }
                        
                        if (attempts >= maxAttempts) {
                            clearInterval(checkVM);
                            console.log('VM nicht direkt zug√§nglich - zeige Editor');
                            showStatus('‚ÑπÔ∏è', 'Projekt manuell laden: Datei ‚Üí Laden', false);
                        }
                    }, 200);
                    
                } catch (error) {
                    console.error('Fehler beim Laden:', error);
                    showStatus('‚ùå', error.message, false, true);
                }
            };
        }
        
        // ============================================
        // Project Control
        // ============================================
        
        function startProject() {
            console.log('Starte Projekt...');
            showStatus('‚ñ∂Ô∏è', 'Projekt gestartet!');
            
            const iframe = document.getElementById('scratch-frame');
            if (iframe && iframe.contentWindow) {
                // Versuche greenFlag zu senden
                try {
                    if (iframe.contentWindow.vm) {
                        iframe.contentWindow.vm.greenFlag();
                        return;
                    }
                } catch (e) {}
                
                // Fallback: Klicke auf gr√ºne Flagge im DOM
                try {
                    const greenFlag = iframe.contentDocument.querySelector('[class*="green-flag"]');
                    if (greenFlag) {
                        greenFlag.click();
                        return;
                    }
                } catch (e) {}
                
                // Noch ein Fallback: postMessage
                iframe.contentWindow.postMessage({ type: 'greenFlag' }, '*');
            }
            
            publishStatus();
        }
        
        function stopProject() {
            console.log('Stoppe Projekt...');
            showStatus('‚èπÔ∏è', 'Projekt gestoppt');
            
            const iframe = document.getElementById('scratch-frame');
            if (iframe && iframe.contentWindow) {
                try {
                    if (iframe.contentWindow.vm) {
                        iframe.contentWindow.vm.stopAll();
                        return;
                    }
                } catch (e) {}
                
                try {
                    const stopBtn = iframe.contentDocument.querySelector('[class*="stop-all"]');
                    if (stopBtn) {
                        stopBtn.click();
                        return;
                    }
                } catch (e) {}
                
                iframe.contentWindow.postMessage({ type: 'stopAll' }, '*');
            }
            
            publishStatus();
        }
        
        // ============================================
        // MQTT Functions
        // ============================================
        
        function connectMQTT() {
            const brokerUrl = `ws://${CONFIG.mqttBroker}:${CONFIG.mqttPort}`;
            console.log(`Verbinde zu MQTT: ${brokerUrl}`);
            
            mqttClient = mqtt.connect(brokerUrl, {
                clientId: 'sidekick-kiosk-' + Math.random().toString(16).substr(2, 8),
                clean: true,
                reconnectPeriod: 5000
            });
            
            mqttClient.on('connect', () => {
                console.log('MQTT verbunden!');
                connectionDot.classList.add('connected');
                showStatus('‚úì', 'Verbunden - Warte auf Projekt...');
                
                mqttClient.subscribe('sidekick/display/#');
                publishStatus();
            });
            
            mqttClient.on('error', (err) => {
                console.error('MQTT Fehler:', err);
                connectionDot.classList.remove('connected');
            });
            
            mqttClient.on('close', () => {
                connectionDot.classList.remove('connected');
            });
            
            mqttClient.on('message', (topic, message) => {
                const payload = message.toString();
                console.log(`MQTT: ${topic} = ${payload}`);
                
                switch(topic) {
                    case 'sidekick/display/load':
                        loadProjectInIframe(payload);
                        break;
                    case 'sidekick/display/start':
                        startProject();
                        break;
                    case 'sidekick/display/stop':
                        stopProject();
                        break;
                    case 'sidekick/display/status':
                        publishStatus();
                        break;
                }
            });
        }
        
        function publishStatus() {
            if (mqttClient && mqttClient.connected) {
                mqttClient.publish('sidekick/display/state', JSON.stringify({
                    status: currentProject ? 'loaded' : 'idle',
                    project: currentProject,
                    timestamp: new Date().toISOString()
                }));
            }
        }
        
        // ============================================
        // Cursor Auto-Hide
        // ============================================
        
        let cursorTimeout;
        document.addEventListener('mousemove', () => {
            document.body.classList.remove('hide-cursor');
            clearTimeout(cursorTimeout);
            cursorTimeout = setTimeout(() => document.body.classList.add('hide-cursor'), 3000);
        });
        
        // ============================================
        // Initialize
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('SIDEKICK Kiosk Player gestartet');
            
            // Optional: Lokale Kontrollen anzeigen
            if (window.location.search.includes('controls=true')) {
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('btn-start').onclick = startProject;
                document.getElementById('btn-stop').onclick = stopProject;
            }
            
            // Cursor ausblenden nach 3s
            cursorTimeout = setTimeout(() => document.body.classList.add('hide-cursor'), 3000);
            
            // Check for project in URL
            const urlParams = new URLSearchParams(window.location.search);
            const projectName = urlParams.get('project');
            
            if (projectName) {
                // Direkt Projekt laden
                setTimeout(() => loadProjectInIframe(projectName), 500);
            }
            
            // MQTT verbinden
            connectMQTT();
        });
    </script>
</body>
</html>
